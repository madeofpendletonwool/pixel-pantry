<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Game Asset Browser</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
                color: #fff;
                min-height: 100vh;
            }

            .container {
                max-width: 1400px;
                margin: 0 auto;
                padding: 20px;
            }

            .header {
                text-align: center;
                margin-bottom: 30px;
            }

            .header h1 {
                font-size: 2.5rem;
                margin-bottom: 10px;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            }

            .controls {
                display: flex;
                gap: 20px;
                margin-bottom: 20px;
                align-items: center;
                flex-wrap: wrap;
            }

            .search-container {
                flex: 1;
                min-width: 300px;
                position: relative;
            }

            .search-input {
                width: 100%;
                padding: 12px 40px 12px 15px;
                border: none;
                border-radius: 25px;
                background: rgba(255, 255, 255, 0.1);
                color: #fff;
                font-size: 1rem;
                backdrop-filter: blur(10px);
            }

            .search-input::placeholder {
                color: #ccc;
            }

            .search-button {
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-50%);
                background: none;
                border: none;
                color: #ffd700;
                font-size: 1.2rem;
                cursor: pointer;
                padding: 5px;
            }

            .view-controls {
                display: flex;
                gap: 10px;
            }

            .view-toggle {
                padding: 8px 15px;
                border: none;
                border-radius: 20px;
                background: rgba(255, 255, 255, 0.1);
                color: #fff;
                cursor: pointer;
                transition: all 0.3s;
            }

            .view-toggle.active {
                background: #ffd700;
                color: #1e3c72;
            }

            .bookmarks-section {
                background: rgba(255, 255, 255, 0.1);
                border-radius: 15px;
                padding: 20px;
                margin-bottom: 20px;
                backdrop-filter: blur(10px);
            }

            .bookmarks-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
            }

            .bookmarks-header h3 {
                color: #ffd700;
                margin: 0;
            }

            .bookmark-toggle {
                background: rgba(255, 255, 255, 0.1);
                border: none;
                color: #fff;
                padding: 6px 12px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.8rem;
                transition: all 0.3s;
            }

            .bookmark-toggle:hover {
                background: rgba(255, 255, 255, 0.2);
            }

            .bookmarks-content {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }

            .bookmark-category {
                background: rgba(255, 255, 255, 0.05);
                border-radius: 10px;
                padding: 15px;
            }

            .bookmark-category h4 {
                color: #ffd700;
                margin-bottom: 10px;
                font-size: 0.9rem;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .bookmark-list {
                display: flex;
                flex-direction: column;
                gap: 8px;
                max-height: 150px;
                overflow-y: auto;
            }

            .bookmark-item {
                background: rgba(255, 255, 255, 0.1);
                padding: 8px 12px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 0.85rem;
                transition: all 0.3s;
                display: flex;
                align-items: center;
                justify-content: space-between;
                word-break: break-word;
            }

            .bookmark-item:hover {
                background: rgba(255, 255, 255, 0.2);
            }

            .bookmark-item-content {
                display: flex;
                align-items: center;
                gap: 8px;
                flex: 1;
                min-width: 0;
            }

            .bookmark-item-name {
                flex: 1;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .bookmark-remove {
                color: #ff6b6b;
                cursor: pointer;
                opacity: 0.7;
                transition: opacity 0.3s;
                padding: 2px;
            }

            .bookmark-remove:hover {
                opacity: 1;
            }

            .bookmarks-collapsed {
                display: none;
            }

            /* Toast Notifications */
            .toast-container {
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 2000;
                pointer-events: none;
            }

            .toast {
                background: rgba(30, 60, 114, 0.95);
                color: #fff;
                padding: 12px 16px;
                border-radius: 8px;
                margin-bottom: 10px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                backdrop-filter: blur(10px);
                border-left: 4px solid #ffd700;
                transform: translateX(400px);
                transition: transform 0.3s ease-out;
                pointer-events: auto;
                max-width: 300px;
                word-wrap: break-word;
            }

            .toast.show {
                transform: translateX(0);
            }

            .toast.success {
                border-left-color: #4caf50;
            }

            .toast.error {
                border-left-color: #f44336;
            }

            .toast.warning {
                border-left-color: #ff9800;
            }

            .toast.info {
                border-left-color: #2196f3;
            }

            .toast-content {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .toast-icon {
                font-size: 1.2rem;
            }

            .toast-message {
                flex: 1;
                font-size: 0.9rem;
            }

            .toast-close {
                cursor: pointer;
                opacity: 0.7;
                transition: opacity 0.3s;
                padding: 2px;
            }

            .toast-close:hover {
                opacity: 1;
            }

            .bookmarks-bar {
                background: rgba(255, 255, 255, 0.1);
                border-radius: 10px;
                padding: 10px 15px;
                margin-bottom: 20px;
                backdrop-filter: blur(10px);
                display: flex;
                align-items: center;
                gap: 10px;
                flex-wrap: wrap;
            }

            .bookmark-item {
                background: rgba(255, 255, 255, 0.1);
                padding: 5px 10px;
                border-radius: 15px;
                cursor: pointer;
                font-size: 0.9rem;
                transition: all 0.3s;
                display: flex;
                align-items: center;
                gap: 5px;
            }

            .bookmark-item:hover {
                background: rgba(255, 255, 255, 0.2);
            }

            .bookmark-remove {
                color: #ff6b6b;
                margin-left: 5px;
                cursor: pointer;
            }

            .breadcrumb {
                background: rgba(255, 255, 255, 0.1);
                padding: 15px;
                border-radius: 10px;
                margin-bottom: 20px;
                backdrop-filter: blur(10px);
                display: flex;
                align-items: center;
                justify-content: space-between;
            }

            .breadcrumb-nav {
                display: flex;
                align-items: center;
            }

            .breadcrumb-actions {
                display: flex;
                gap: 10px;
            }

            .bookmark-btn,
            .bookmark-file-btn {
                background: rgba(255, 255, 255, 0.1);
                border: none;
                color: #fff;
                padding: 8px 12px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 0.9rem;
                transition: all 0.3s;
            }

            .bookmark-btn:hover,
            .bookmark-file-btn:hover {
                background: rgba(255, 255, 255, 0.2);
            }

            .breadcrumb-item {
                display: inline-block;
                cursor: pointer;
                padding: 5px 10px;
                border-radius: 5px;
                transition: background 0.3s;
            }

            .breadcrumb-item:hover {
                background: rgba(255, 255, 255, 0.2);
            }

            .breadcrumb-separator {
                margin: 0 5px;
                color: #ccc;
            }

            .content {
                display: grid;
                grid-template-columns: 300px 1fr;
                gap: 20px;
                min-height: 600px;
            }

            .sidebar {
                background: rgba(255, 255, 255, 0.1);
                border-radius: 15px;
                padding: 20px;
                backdrop-filter: blur(10px);
                height: fit-content;
            }

            .sidebar h3 {
                margin-bottom: 15px;
                color: #ffd700;
            }

            .directory-list {
                list-style: none;
                max-height: 500px;
                overflow-y: auto;
            }

            .directory-item {
                padding: 10px;
                cursor: pointer;
                border-radius: 8px;
                margin-bottom: 5px;
                transition: all 0.3s;
                display: flex;
                align-items: center;
            }

            .directory-item:hover {
                background: rgba(255, 255, 255, 0.2);
                transform: translateX(5px);
            }

            .directory-item::before {
                content: "📁";
                margin-right: 10px;
                font-size: 1.2rem;
            }

            .main-content {
                background: rgba(255, 255, 255, 0.1);
                border-radius: 15px;
                padding: 20px;
                backdrop-filter: blur(10px);
            }

            .files-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 20px;
                margin-top: 20px;
            }

            .files-list {
                display: none;
            }

            .files-list.active {
                display: block;
            }

            .files-grid.active {
                display: grid;
            }

            .file-row {
                background: rgba(255, 255, 255, 0.1);
                border-radius: 8px;
                padding: 10px 15px;
                margin-bottom: 5px;
                display: flex;
                align-items: center;
                gap: 15px;
                cursor: pointer;
                transition: all 0.3s;
            }

            .file-row:hover {
                background: rgba(255, 255, 255, 0.2);
                transform: translateX(5px);
            }

            .file-icon-small {
                font-size: 1.5rem;
                min-width: 30px;
            }

            .file-details {
                flex: 1;
            }

            .file-card {
                background: rgba(255, 255, 255, 0.1);
                border-radius: 12px;
                padding: 15px;
                transition: all 0.3s;
                cursor: pointer;
                border: 2px solid transparent;
            }

            .file-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
                border-color: #ffd700;
            }

            .file-preview {
                width: 100%;
                height: 150px;
                background: rgba(0, 0, 0, 0.3);
                border-radius: 8px;
                margin-bottom: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                overflow: hidden;
            }

            .file-preview img {
                max-width: 100%;
                max-height: 100%;
                object-fit: contain;
            }

            .file-icon {
                font-size: 3rem;
                opacity: 0.7;
            }

            .file-name {
                font-weight: bold;
                margin-bottom: 5px;
                word-break: break-word;
            }

            .file-info {
                font-size: 0.9rem;
                color: #ccc;
            }

            .loading {
                text-align: center;
                padding: 50px;
                font-size: 1.2rem;
            }

            .error {
                background: rgba(255, 0, 0, 0.2);
                border: 1px solid #ff6b6b;
                border-radius: 8px;
                padding: 15px;
                margin: 20px 0;
            }

            .search-results {
                margin-top: 20px;
            }

            .search-result-item {
                background: rgba(255, 255, 255, 0.1);
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 10px;
                cursor: pointer;
                transition: all 0.3s;
            }

            .search-result-item:hover {
                background: rgba(255, 255, 255, 0.2);
            }

            .search-result-path {
                font-size: 0.9rem;
                color: #ccc;
                margin-top: 5px;
            }

            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                z-index: 1000;
                padding: 20px;
            }

            .modal-content {
                background: rgba(30, 60, 114, 0.95);
                border-radius: 15px;
                padding: 30px;
                max-width: 90%;
                max-height: 90%;
                margin: 0 auto;
                position: relative;
                overflow: auto;
                backdrop-filter: blur(10px);
            }

            .modal-close {
                position: absolute;
                top: 15px;
                right: 20px;
                font-size: 2rem;
                cursor: pointer;
                color: #fff;
            }

            .modal-preview {
                text-align: center;
                margin-bottom: 20px;
                position: relative;
                overflow: hidden;
                border-radius: 10px;
                background: rgba(0, 0, 0, 0.3);
                min-height: 200px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .modal-preview img {
                max-width: 100%;
                max-height: 70vh;
                object-fit: contain;
                cursor: grab;
                transition: transform 0.1s ease-out;
                user-select: none;
                -webkit-user-select: none;
                -moz-user-select: none;
            }

            .modal-preview img:active {
                cursor: grabbing;
            }

            .modal-preview img.zoomed {
                cursor: grab;
            }

            .image-controls {
                position: absolute;
                top: 10px;
                right: 10px;
                display: flex;
                gap: 8px;
                background: rgba(0, 0, 0, 0.7);
                border-radius: 8px;
                padding: 8px;
                backdrop-filter: blur(10px);
            }

            .image-control-btn {
                background: rgba(255, 255, 255, 0.1);
                border: none;
                color: #fff;
                width: 32px;
                height: 32px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.9rem;
                transition: all 0.3s;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .image-control-btn:hover {
                background: rgba(255, 255, 255, 0.2);
                transform: scale(1.1);
            }

            .zoom-info {
                position: absolute;
                bottom: 10px;
                left: 10px;
                background: rgba(0, 0, 0, 0.7);
                color: #fff;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 0.8rem;
                backdrop-filter: blur(10px);
            }

            .image-size-info {
                position: absolute;
                bottom: 10px;
                right: 10px;
                background: rgba(0, 0, 0, 0.7);
                color: #fff;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 0.8rem;
                backdrop-filter: blur(10px);
            }

            @media (max-width: 768px) {
                .content {
                    grid-template-columns: 1fr;
                }

                .sidebar {
                    order: 1;
                }

                .files-grid {
                    grid-template-columns: repeat(
                        auto-fill,
                        minmax(200px, 1fr)
                    );
                }

                .controls {
                    flex-direction: column;
                    align-items: stretch;
                }

                .search-container {
                    min-width: auto;
                }
            }
        </style>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js"></script>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>🎮 Game Asset Browser</h1>
                <p>Browse and preview your game assets with ease</p>
            </div>

            <div class="controls">
                <div class="search-container">
                    <input
                        type="text"
                        class="search-input"
                        placeholder="Search assets..."
                        id="searchInput"
                    />
                    <button class="search-button" onclick="performSearch()">
                        🔍
                    </button>
                </div>
                <div class="view-controls">
                    <button
                        class="view-toggle active"
                        onclick="toggleView('grid')"
                    >
                        Grid
                    </button>
                    <button class="view-toggle" onclick="toggleView('list')">
                        List
                    </button>
                </div>
            </div>

            <div class="bookmarks-section" id="bookmarksSection">
                <div class="bookmarks-header">
                    <h3>⭐ Bookmarks</h3>
                    <button class="bookmark-toggle" onclick="toggleBookmarks()">
                        Hide
                    </button>
                </div>
                <div class="bookmarks-content" id="bookmarksContent">
                    <div class="bookmark-category">
                        <h4>📁 Directories</h4>
                        <div class="bookmark-list" id="directoryBookmarks">
                            <!-- Directory bookmarks will be loaded here -->
                        </div>
                    </div>
                    <div class="bookmark-category">
                        <h4>📄 Files</h4>
                        <div class="bookmark-list" id="fileBookmarks">
                            <!-- File bookmarks will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="breadcrumb" id="breadcrumb">
                <div class="breadcrumb-nav">
                    <span class="breadcrumb-item" onclick="navigateTo('')"
                        >🏠 Assets</span
                    >
                </div>
                <div class="breadcrumb-actions">
                    <button
                        class="bookmark-btn"
                        onclick="bookmarkCurrentPath()"
                    >
                        ⭐ Directory
                    </button>
                </div>
            </div>

            <div class="content">
                <div class="sidebar">
                    <h3>📂 Directories</h3>
                    <ul class="directory-list" id="directoryList">
                        <!-- Directories will be loaded here -->
                    </ul>
                </div>

                <div class="main-content">
                    <div class="loading" id="loading">Loading assets...</div>
                    <div class="files-grid active" id="filesGrid">
                        <!-- Files will be loaded here -->
                    </div>
                    <div class="files-list" id="filesList">
                        <!-- List view will be here -->
                    </div>
                    <div
                        class="search-results"
                        id="searchResults"
                        style="display: none"
                    >
                        <!-- Search results will be here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast Container -->
        <div class="toast-container" id="toastContainer"></div>

        <!-- Modal for file preview -->
        <div class="modal" id="fileModal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeModal()">&times;</span>
                <div id="modalContent">
                    <!-- Modal content will be loaded here -->
                </div>
            </div>
        </div>

        <script>
            let currentPath = "";
            let currentView = "grid";
            let allFiles = [];
            let searchMode = false;
            let directoryBookmarks = [];
            let fileBookmarks = [];
            let fuse = null;
            let pathHistory = [""];
            let historyIndex = 0;

            // Toast notification system
            function showToast(message, type = "info", duration = 3000) {
                const container = document.getElementById("toastContainer");

                const toast = document.createElement("div");
                toast.className = `toast ${type}`;

                const icons = {
                    success: "✅",
                    error: "❌",
                    warning: "⚠️",
                    info: "ℹ️",
                };

                toast.innerHTML = `
                <div class="toast-content">
                    <span class="toast-icon">${icons[type] || icons.info}</span>
                    <span class="toast-message">${message}</span>
                    <span class="toast-close" onclick="removeToast(this.parentElement.parentElement)">&times;</span>
                </div>
            `;

                container.appendChild(toast);

                // Trigger animation
                setTimeout(() => toast.classList.add("show"), 10);

                // Auto remove
                setTimeout(() => removeToast(toast), duration);

                return toast;
            }

            function removeToast(toast) {
                if (toast && toast.parentElement) {
                    toast.classList.remove("show");
                    setTimeout(() => {
                        if (toast.parentElement) {
                            toast.parentElement.removeChild(toast);
                        }
                    }, 300);
                }
            }

            // Handle browser back/forward buttons
            window.addEventListener("popstate", function (event) {
                if (event.state && event.state.path !== undefined) {
                    loadDirectory(event.state.path, false); // false = don't push to history
                }
            });

            // Extract tags from filename for search
            function extractTags(filename) {
                const name = filename.replace(/\.[^/.]+$/, ""); // Remove extension
                return name
                    .toLowerCase()
                    .split(/[_\-\s\.]+/)
                    .filter((tag) => tag.length > 2)
                    .filter((tag) => !/^\d+$/.test(tag)); // Remove pure numbers
            }

            // Initialize fuzzy search
            function initializeFuzzySearch(files) {
                const searchData = files.map((file) => ({
                    ...file,
                    tags: extractTags(file.name),
                }));

                fuse = new Fuse(searchData, {
                    keys: [
                        { name: "name", weight: 0.7 },
                        { name: "tags", weight: 0.3 },
                    ],
                    threshold: 0.4,
                    includeScore: true,
                });
            }

            // Load bookmarks from localStorage
            function loadBookmarks() {
                try {
                    const savedDirs = localStorage.getItem(
                        "assetBrowserDirectoryBookmarks",
                    );
                    const savedFiles = localStorage.getItem(
                        "assetBrowserFileBookmarks",
                    );
                    directoryBookmarks = savedDirs ? JSON.parse(savedDirs) : [];
                    fileBookmarks = savedFiles ? JSON.parse(savedFiles) : [];
                    renderBookmarks();
                } catch (error) {
                    console.error("Error loading bookmarks:", error);
                    directoryBookmarks = [];
                    fileBookmarks = [];
                }
            }

            // Save bookmarks to localStorage
            function saveBookmarks() {
                try {
                    localStorage.setItem(
                        "assetBrowserDirectoryBookmarks",
                        JSON.stringify(directoryBookmarks),
                    );
                    localStorage.setItem(
                        "assetBrowserFileBookmarks",
                        JSON.stringify(fileBookmarks),
                    );
                } catch (error) {
                    console.error("Error saving bookmarks:", error);
                }
            }

            // Render bookmarks section
            function renderBookmarks() {
                const dirBookmarks =
                    document.getElementById("directoryBookmarks");
                const fileBookmarksEl =
                    document.getElementById("fileBookmarks");

                // Render directory bookmarks
                if (directoryBookmarks.length === 0) {
                    dirBookmarks.innerHTML =
                        '<div style="color: #ccc; font-style: italic; padding: 10px;">No directory bookmarks</div>';
                } else {
                    dirBookmarks.innerHTML = directoryBookmarks
                        .map(
                            (bookmark, index) =>
                                `<div class="bookmark-item" onclick="navigateTo('${bookmark.path}')">
                        <div class="bookmark-item-content">
                            <span>📁</span>
                            <span class="bookmark-item-name" title="${bookmark.name}">${bookmark.name}</span>
                        </div>
                        <span class="bookmark-remove" onclick="event.stopPropagation(); removeDirectoryBookmark(${index})">&times;</span>
                    </div>`,
                        )
                        .join("");
                }

                // Render file bookmarks
                if (fileBookmarks.length === 0) {
                    fileBookmarksEl.innerHTML =
                        '<div style="color: #ccc; font-style: italic; padding: 10px;">No file bookmarks</div>';
                } else {
                    fileBookmarksEl.innerHTML = fileBookmarks
                        .map(
                            (bookmark, index) =>
                                `<div class="bookmark-item" onclick="openBookmarkedFile('${bookmark.path}')">
                        <div class="bookmark-item-content">
                            <span>${getFileIcon(bookmark.type)}</span>
                            <span class="bookmark-item-name" title="${bookmark.name}">${bookmark.name}</span>
                        </div>
                        <span class="bookmark-remove" onclick="event.stopPropagation(); removeFileBookmark(${index})">&times;</span>
                    </div>`,
                        )
                        .join("");
                }
            }

            // Toggle bookmarks section
            function toggleBookmarks() {
                const content = document.getElementById("bookmarksContent");
                const toggle = document.querySelector(".bookmark-toggle");

                if (content.classList.contains("bookmarks-collapsed")) {
                    content.classList.remove("bookmarks-collapsed");
                    toggle.textContent = "Hide";
                } else {
                    content.classList.add("bookmarks-collapsed");
                    toggle.textContent = "Show";
                }
            }

            // Add directory bookmark
            function bookmarkCurrentPath() {
                const name = prompt(
                    "Bookmark name:",
                    currentPath || "Assets Root",
                );
                if (name && name.trim()) {
                    const bookmark = {
                        name: name.trim(),
                        path: currentPath,
                    };

                    // Check if already bookmarked
                    if (
                        !directoryBookmarks.find((b) => b.path === currentPath)
                    ) {
                        directoryBookmarks.push(bookmark);
                        saveBookmarks();
                        renderBookmarks();
                        showToast(
                            "Directory bookmarked successfully!",
                            "success",
                        );
                    } else {
                        showToast(
                            "This directory is already bookmarked!",
                            "warning",
                        );
                    }
                }
            }

            // Add file bookmark
            function bookmarkFile(file) {
                const bookmark = {
                    name: file.name,
                    path: file.path,
                    type: file.type,
                    parentPath: currentPath,
                };

                // Check if already bookmarked
                if (!fileBookmarks.find((b) => b.path === file.path)) {
                    fileBookmarks.push(bookmark);
                    saveBookmarks();
                    renderBookmarks();
                    showToast(`File "${file.name}" bookmarked!`, "success");
                } else {
                    showToast("This file is already bookmarked!", "warning");
                }
            }

            // Remove directory bookmark
            function removeDirectoryBookmark(index) {
                directoryBookmarks.splice(index, 1);
                saveBookmarks();
                renderBookmarks();
            }

            // Remove file bookmark
            function removeFileBookmark(index) {
                fileBookmarks.splice(index, 1);
                saveBookmarks();
                renderBookmarks();
            }

            // Image viewer state
            let imageViewerState = {
                scale: 1,
                translateX: 0,
                translateY: 0,
                isDragging: false,
                lastX: 0,
                lastY: 0,
                originalWidth: 0,
                originalHeight: 0,
            };

            // Initialize image viewer
            function initImageViewer(img) {
                // Reset state
                imageViewerState = {
                    scale: 1,
                    translateX: 0,
                    translateY: 0,
                    isDragging: false,
                    lastX: 0,
                    lastY: 0,
                    originalWidth: img.naturalWidth,
                    originalHeight: img.naturalHeight,
                };

                updateImageTransform(img);
                updateImageInfo(img);

                // Mouse wheel zoom
                img.addEventListener("wheel", (e) => {
                    e.preventDefault();
                    const rect = img.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;

                    const delta = e.deltaY > 0 ? 0.9 : 1.1;
                    const newScale = Math.max(
                        0.1,
                        Math.min(5, imageViewerState.scale * delta),
                    );

                    // Zoom towards mouse position
                    const scaleDiff = newScale / imageViewerState.scale;
                    imageViewerState.translateX =
                        x - (x - imageViewerState.translateX) * scaleDiff;
                    imageViewerState.translateY =
                        y - (y - imageViewerState.translateY) * scaleDiff;
                    imageViewerState.scale = newScale;

                    updateImageTransform(img);
                    updateImageInfo(img);
                });

                // Mouse drag
                img.addEventListener("mousedown", (e) => {
                    e.preventDefault();
                    imageViewerState.isDragging = true;
                    imageViewerState.lastX = e.clientX;
                    imageViewerState.lastY = e.clientY;
                    img.style.cursor = "grabbing";
                });

                document.addEventListener("mousemove", (e) => {
                    if (!imageViewerState.isDragging) return;

                    const deltaX = e.clientX - imageViewerState.lastX;
                    const deltaY = e.clientY - imageViewerState.lastY;

                    imageViewerState.translateX += deltaX;
                    imageViewerState.translateY += deltaY;
                    imageViewerState.lastX = e.clientX;
                    imageViewerState.lastY = e.clientY;

                    updateImageTransform(img);
                });

                document.addEventListener("mouseup", () => {
                    if (imageViewerState.isDragging) {
                        imageViewerState.isDragging = false;
                        img.style.cursor =
                            imageViewerState.scale > 1 ? "grab" : "grab";
                    }
                });

                // Touch support for mobile
                let lastTouchDistance = 0;

                img.addEventListener("touchstart", (e) => {
                    e.preventDefault();
                    if (e.touches.length === 1) {
                        imageViewerState.isDragging = true;
                        imageViewerState.lastX = e.touches[0].clientX;
                        imageViewerState.lastY = e.touches[0].clientY;
                    } else if (e.touches.length === 2) {
                        const touch1 = e.touches[0];
                        const touch2 = e.touches[1];
                        lastTouchDistance = Math.sqrt(
                            Math.pow(touch2.clientX - touch1.clientX, 2) +
                                Math.pow(touch2.clientY - touch1.clientY, 2),
                        );
                    }
                });

                img.addEventListener("touchmove", (e) => {
                    e.preventDefault();
                    if (e.touches.length === 1 && imageViewerState.isDragging) {
                        const deltaX =
                            e.touches[0].clientX - imageViewerState.lastX;
                        const deltaY =
                            e.touches[0].clientY - imageViewerState.lastY;

                        imageViewerState.translateX += deltaX;
                        imageViewerState.translateY += deltaY;
                        imageViewerState.lastX = e.touches[0].clientX;
                        imageViewerState.lastY = e.touches[0].clientY;

                        updateImageTransform(img);
                    } else if (e.touches.length === 2) {
                        const touch1 = e.touches[0];
                        const touch2 = e.touches[1];
                        const currentDistance = Math.sqrt(
                            Math.pow(touch2.clientX - touch1.clientX, 2) +
                                Math.pow(touch2.clientY - touch1.clientY, 2),
                        );

                        if (lastTouchDistance > 0) {
                            const scaleDelta =
                                currentDistance / lastTouchDistance;
                            imageViewerState.scale = Math.max(
                                0.1,
                                Math.min(
                                    5,
                                    imageViewerState.scale * scaleDelta,
                                ),
                            );
                            updateImageTransform(img);
                            updateImageInfo(img);
                        }

                        lastTouchDistance = currentDistance;
                    }
                });

                img.addEventListener("touchend", () => {
                    imageViewerState.isDragging = false;
                    lastTouchDistance = 0;
                });
            }

            // Update image transform
            function updateImageTransform(img) {
                img.style.transform = `translate(${imageViewerState.translateX}px, ${imageViewerState.translateY}px) scale(${imageViewerState.scale})`;
                img.style.transformOrigin = "0 0";

                if (imageViewerState.scale > 1) {
                    img.classList.add("zoomed");
                } else {
                    img.classList.remove("zoomed");
                }
            }

            // Update image info display
            function updateImageInfo(img) {
                const zoomInfo = document.querySelector(".zoom-info");
                const sizeInfo = document.querySelector(".image-size-info");

                if (zoomInfo) {
                    zoomInfo.textContent = `${Math.round(imageViewerState.scale * 100)}%`;
                }

                if (sizeInfo) {
                    sizeInfo.textContent = `${imageViewerState.originalWidth} × ${imageViewerState.originalHeight}`;
                }
            }

            // Image control functions
            function zoomIn(img) {
                imageViewerState.scale = Math.min(
                    5,
                    imageViewerState.scale * 1.2,
                );
                updateImageTransform(img);
                updateImageInfo(img);
            }

            function zoomOut(img) {
                imageViewerState.scale = Math.max(
                    0.1,
                    imageViewerState.scale / 1.2,
                );
                updateImageTransform(img);
                updateImageInfo(img);
            }

            function resetZoom(img) {
                imageViewerState.scale = 1;
                imageViewerState.translateX = 0;
                imageViewerState.translateY = 0;
                updateImageTransform(img);
                updateImageInfo(img);
            }

            function fitToScreen(img) {
                const container = img.parentElement;
                const containerWidth = container.clientWidth - 40;
                const containerHeight = container.clientHeight - 40;

                const scaleX = containerWidth / imageViewerState.originalWidth;
                const scaleY =
                    containerHeight / imageViewerState.originalHeight;

                imageViewerState.scale = Math.min(scaleX, scaleY, 1);
                imageViewerState.translateX = 0;
                imageViewerState.translateY = 0;
                updateImageTransform(img);
                updateImageInfo(img);
            }
            function openBookmarkedFile(filePath) {
                // Navigate to parent directory first, then open file
                const parentPath = filePath.substring(
                    0,
                    filePath.lastIndexOf("/"),
                );
                navigateTo(parentPath)
                    .then(() => {
                        // Find the file in current directory and open it
                        const file = allFiles.find((f) => f.path === filePath);
                        if (file) {
                            openFileModal(file);
                            showToast(
                                "Opening bookmarked file...",
                                "info",
                                2000,
                            );
                        } else {
                            showToast(
                                "File not found. It may have been moved or deleted.",
                                "error",
                            );
                        }
                    })
                    .catch(() => {
                        showToast(
                            "Could not navigate to file location.",
                            "error",
                        );
                    });
            }

            // Load directory contents
            async function loadDirectory(path = "", pushToHistory = true) {
                try {
                    document.getElementById("loading").style.display = "block";
                    document.getElementById("filesGrid").innerHTML = "";
                    document.getElementById("filesList").innerHTML = "";
                    searchMode = false;
                    document.getElementById("searchResults").style.display =
                        "none";

                    const response = await fetch(
                        `/api/browse?path=${encodeURIComponent(path)}`,
                    );
                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(
                            data.error || "Failed to load directory",
                        );
                    }

                    currentPath = path;
                    allFiles = data.files;

                    // Handle browser history
                    if (pushToHistory) {
                        // Add to our path history
                        pathHistory = pathHistory.slice(0, historyIndex + 1);
                        pathHistory.push(path);
                        historyIndex = pathHistory.length - 1;

                        // Push to browser history
                        const title = path ? `Assets - ${path}` : "Assets";
                        history.pushState({ path: path }, title, `#${path}`);
                    }

                    // Initialize fuzzy search with tags
                    initializeFuzzySearch(allFiles);

                    updateBreadcrumb(data.pathParts);
                    renderDirectories(data.directories);
                    renderFiles(data.files);

                    return Promise.resolve();
                } catch (error) {
                    console.error("Error loading directory:", error);
                    document.getElementById("filesGrid").innerHTML =
                        `<div class="error">Error loading directory: ${error.message}</div>`;
                    return Promise.reject(error);
                } finally {
                    document.getElementById("loading").style.display = "none";
                }
            }

            // Update breadcrumb navigation
            function updateBreadcrumb(pathParts) {
                const breadcrumbNav = document.querySelector(".breadcrumb-nav");
                breadcrumbNav.innerHTML =
                    '<span class="breadcrumb-item" onclick="navigateTo(\'\')">🏠 Assets</span>';

                let currentPath = "";
                pathParts.forEach((part, index) => {
                    currentPath += (index > 0 ? "/" : "") + part;
                    breadcrumbNav.innerHTML += `<span class="breadcrumb-separator">/</span>
                     <span class="breadcrumb-item" onclick="navigateTo('${currentPath}')">${part}</span>`;
                });
            }

            // Render directories in sidebar
            function renderDirectories(directories) {
                const dirList = document.getElementById("directoryList");
                dirList.innerHTML = "";

                directories.forEach((dir) => {
                    const li = document.createElement("li");
                    li.className = "directory-item";
                    li.textContent = dir.name;
                    li.onclick = () => navigateTo(dir.path);
                    dirList.appendChild(li);
                });
            }

            // Render files based on current view
            function renderFiles(files) {
                if (currentView === "grid") {
                    renderGridView(files);
                } else {
                    renderListView(files);
                }
            }

            // Render grid view
            function renderGridView(files) {
                const filesGrid = document.getElementById("filesGrid");
                const filesList = document.getElementById("filesList");

                filesGrid.style.display = "grid";
                filesList.style.display = "none";
                filesGrid.innerHTML = "";

                if (files.length === 0) {
                    filesGrid.innerHTML =
                        '<div style="grid-column: 1/-1; text-align: center; padding: 50px;">No files found in this directory</div>';
                    return;
                }

                files.forEach((file) => {
                    const fileCard = document.createElement("div");
                    fileCard.className = "file-card";
                    fileCard.onclick = () => openFileModal(file);

                    const preview = createFilePreview(file);
                    const sizeFormatted = formatFileSize(file.size);

                    fileCard.innerHTML = `
                    <div class="file-preview">${preview}</div>
                    <div class="file-name">${file.name}</div>
                    <div class="file-info">${file.type.toUpperCase()} • ${sizeFormatted}</div>
                `;

                    // Add right-click context menu for bookmarking
                    fileCard.addEventListener("contextmenu", (e) => {
                        e.preventDefault();
                        const existingMenu =
                            document.querySelector(".context-menu");
                        if (existingMenu) existingMenu.remove();

                        const menu = document.createElement("div");
                        menu.className = "context-menu";
                        menu.style.cssText = `
                        position: fixed;
                        top: ${e.clientY}px;
                        left: ${e.clientX}px;
                        background: rgba(30, 60, 114, 0.95);
                        border-radius: 8px;
                        padding: 8px 0;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        z-index: 1001;
                        backdrop-filter: blur(10px);
                    `;

                        const bookmarkOption = document.createElement("div");
                        bookmarkOption.textContent = "⭐ Bookmark File";
                        bookmarkOption.style.cssText = `
                        padding: 8px 16px;
                        cursor: pointer;
                        color: #fff;
                        font-size: 0.9rem;
                        transition: background 0.3s;
                    `;
                        bookmarkOption.onmouseover = () =>
                            (bookmarkOption.style.background =
                                "rgba(255,255,255,0.1)");
                        bookmarkOption.onmouseout = () =>
                            (bookmarkOption.style.background = "transparent");
                        bookmarkOption.onclick = () => {
                            bookmarkFile(file);
                            menu.remove();
                        };

                        menu.appendChild(bookmarkOption);
                        document.body.appendChild(menu);

                        // Remove menu when clicking elsewhere
                        const removeMenu = () => {
                            menu.remove();
                            document.removeEventListener("click", removeMenu);
                        };
                        setTimeout(
                            () =>
                                document.addEventListener("click", removeMenu),
                            10,
                        );
                    });

                    filesGrid.appendChild(fileCard);
                });
            }

            // Render list view
            function renderListView(files) {
                const filesGrid = document.getElementById("filesGrid");
                const filesList = document.getElementById("filesList");

                filesGrid.style.display = "none";
                filesList.style.display = "block";
                filesList.innerHTML = "";

                if (files.length === 0) {
                    filesList.innerHTML =
                        '<div style="text-align: center; padding: 50px;">No files found in this directory</div>';
                    return;
                }

                files.forEach((file) => {
                    const fileRow = document.createElement("div");
                    fileRow.className = "file-row";
                    fileRow.onclick = () => openFileModal(file);

                    const icon = getFileIcon(file.type);
                    const sizeFormatted = formatFileSize(file.size);
                    const dateFormatted = new Date(
                        file.modified,
                    ).toLocaleDateString();

                    fileRow.innerHTML = `
                    <div class="file-icon-small">${icon}</div>
                    <div class="file-details">
                        <div class="file-name">${file.name}</div>
                        <div class="file-info">${file.type.toUpperCase()} • ${sizeFormatted} • Modified ${dateFormatted}</div>
                    </div>
                `;

                    filesList.appendChild(fileRow);
                });
            }

            // Get file icon based on type
            function getFileIcon(type) {
                switch (type) {
                    case "image":
                        return "🖼️";
                    case "audio":
                        return "🎵";
                    case "video":
                        return "🎬";
                    case "archive":
                        return "📦";
                    case "game":
                        return "🎮";
                    case "text":
                        return "📄";
                    default:
                        return "📄";
                }
            }

            // Create file preview based on type
            function createFilePreview(file) {
                const filePath = `/assets/${file.path}`;

                switch (file.type) {
                    case "image":
                        return `<img src="${filePath}" alt="${file.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <div class="file-icon" style="display:none;">🖼️</div>`;
                    case "audio":
                        return `<div class="file-icon">🎵</div>`;
                    case "video":
                        return `<div class="file-icon">🎬</div>`;
                    case "archive":
                        return `<div class="file-icon">📦</div>`;
                    case "game":
                        return `<div class="file-icon">🎮</div>`;
                    case "text":
                        return `<div class="file-icon">📄</div>`;
                    default:
                        return `<div class="file-icon">📄</div>`;
                }
            }

            // Toggle between grid and list view
            function toggleView(view) {
                currentView = view;

                document.querySelectorAll(".view-toggle").forEach((btn) => {
                    btn.classList.remove("active");
                });
                event.target.classList.add("active");

                if (!searchMode) {
                    renderFiles(allFiles);
                }
            }

            // Perform search with fuzzy matching and tags
            async function performSearch() {
                const query = document
                    .getElementById("searchInput")
                    .value.trim();

                if (query.length < 2) {
                    showToast(
                        "Please enter at least 2 characters to search",
                        "warning",
                    );
                    return;
                }

                document.getElementById("loading").style.display = "block";

                try {
                    let results = [];

                    // Try fuzzy search on current directory first
                    if (fuse && allFiles.length > 0) {
                        const fuzzyResults = fuse.search(query);
                        results = fuzzyResults.map((result) => result.item);
                    }

                    // If no local results or we want global search, search server
                    if (results.length === 0) {
                        const response = await fetch("/api/search", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ query }),
                        });
                        const data = await response.json();

                        if (!response.ok) {
                            throw new Error(data.error || "Search failed");
                        }

                        results = data.results;
                    }

                    searchMode = true;
                    displaySearchResults(results, query);

                    if (results.length > 0) {
                        showToast(
                            `Found ${results.length} results for "${query}"`,
                            "success",
                            2000,
                        );
                    } else {
                        showToast(
                            `No results found for "${query}"`,
                            "info",
                            2000,
                        );
                    }
                } catch (error) {
                    console.error("Search error:", error);
                    showToast("Search failed: " + error.message, "error");
                } finally {
                    document.getElementById("loading").style.display = "none";
                }
            }

            // Display search results
            function displaySearchResults(results, query) {
                const searchResults = document.getElementById("searchResults");
                const filesGrid = document.getElementById("filesGrid");
                const filesList = document.getElementById("filesList");

                filesGrid.style.display = "none";
                filesList.style.display = "none";
                searchResults.style.display = "block";

                searchResults.innerHTML = `
                <h3>Search Results for "${query}" (${results.length} found)</h3>
                <button onclick="clearSearch()" style="margin-bottom: 20px; padding: 8px 15px; border: none; border-radius: 20px; background: #ffd700; color: #1e3c72; cursor: pointer;">Clear Search</button>
            `;

                if (results.length === 0) {
                    searchResults.innerHTML +=
                        '<div style="text-align: center; padding: 50px;">No files found matching your search</div>';
                    return;
                }

                results.forEach((result) => {
                    const resultItem = document.createElement("div");
                    resultItem.className = "search-result-item";
                    resultItem.onclick = () => {
                        if (result.type === "directory") {
                            navigateTo(result.path);
                        } else {
                            openFileModal(result);
                        }
                    };

                    const icon =
                        result.type === "directory"
                            ? "📁"
                            : getFileIcon(result.type);
                    const typeLabel =
                        result.type === "directory"
                            ? "Folder"
                            : result.type?.toUpperCase() || "File";
                    const sizeInfo = result.size
                        ? ` • ${formatFileSize(result.size)}`
                        : "";

                    resultItem.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.5rem;">${icon}</span>
                        <div>
                            <div class="file-name">${result.name}</div>
                            <div class="search-result-path">📁 ${result.parent_path || "Root"} • ${typeLabel}${sizeInfo}</div>
                        </div>
                    </div>
                `;

                    searchResults.appendChild(resultItem);
                });
            }

            // Clear search and return to directory view
            function clearSearch() {
                searchMode = false;
                document.getElementById("searchInput").value = "";
                document.getElementById("searchResults").style.display = "none";
                renderFiles(allFiles);
            }

            // Format file size
            function formatFileSize(bytes) {
                if (bytes === 0) return "0 Bytes";
                const k = 1024;
                const sizes = ["Bytes", "KB", "MB", "GB"];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return (
                    parseFloat((bytes / Math.pow(k, i)).toFixed(2)) +
                    " " +
                    sizes[i]
                );
            }

            // Navigate to directory
            function navigateTo(path) {
                clearSearch();
                return loadDirectory(path);
            }

            // Open file modal
            function openFileModal(file) {
                const modal = document.getElementById("fileModal");
                const modalContent = document.getElementById("modalContent");
                const filePath = `/assets/${file.path}`;

                let content = `
                <h2>${file.name}</h2>
                <div class="file-info" style="margin-bottom: 20px;">
                    Type: ${file.type} • Size: ${formatFileSize(file.size)}
                    ${file.modified ? `<br>Modified: ${new Date(file.modified).toLocaleString()}` : ""}
                </div>
            `;

                switch (file.type) {
                    case "image":
                        content += `<div class="modal-preview"><img src="${filePath}" alt="${file.name}"></div>`;
                        break;
                    case "audio":
                        content += `<div class="modal-preview">
                        <audio controls style="width: 100%;">
                            <source src="${filePath}" type="${file.mimeType || "audio/mpeg"}">
                            Your browser does not support the audio element.
                        </audio>
                    </div>`;
                        break;
                    case "video":
                        content += `<div class="modal-preview">
                        <video controls style="max-width: 100%; max-height: 70vh;">
                            <source src="${filePath}" type="${file.mimeType || "video/mp4"}">
                            Your browser does not support the video element.
                        </video>
                    </div>`;
                        break;
                    case "text":
                        content += `<div class="modal-preview" id="textPreview">
                        <div style="padding: 20px; text-align: center;">Loading content...</div>
                    </div>`;
                        modalContent.innerHTML = content;
                        modal.style.display = "block";
                        loadTextContent(file.path);
                        return;
                    default:
                        content += `<div class="modal-preview">
                        <div style="padding: 50px; text-align: center; background: rgba(0,0,0,0.3); border-radius: 10px;">
                            <div style="font-size: 4rem; margin-bottom: 20px;">${getFileIcon(file.type)}</div>
                            <p>Preview not available for this file type</p>
                            <a href="${filePath}" target="_blank" style="color: #ffd700; text-decoration: none;">Open file</a>
                        </div>
                    </div>`;
                }

                modalContent.innerHTML = content;
                modal.style.display = "block";
            }

            // Load and display text content
            async function loadTextContent(filePath) {
                try {
                    const response = await fetch(
                        `/api/file-content?path=${encodeURIComponent(filePath)}`,
                    );
                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || "Failed to load content");
                    }

                    const textPreview = document.getElementById("textPreview");

                    if (data.extension === ".md") {
                        const htmlContent = marked.parse(data.content);
                        textPreview.innerHTML = `
                        <div style="text-align: left; background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; max-height: 60vh; overflow-y: auto;">
                            <div style="color: #fff;">${htmlContent}</div>
                        </div>
                    `;
                    } else {
                        textPreview.innerHTML = `
                        <div style="text-align: left; background: rgba(0,0,0,0.5); padding: 20px; border-radius: 10px; max-height: 60vh; overflow-y: auto;">
                            <pre style="color: #fff; white-space: pre-wrap; font-family: 'Courier New', monospace; margin: 0;">${escapeHtml(data.content)}</pre>
                        </div>
                    `;
                    }
                } catch (error) {
                    console.error("Error loading text content:", error);
                    document.getElementById("textPreview").innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #ff6b6b;">
                        Error loading content: ${error.message}
                    </div>
                `;
                }
            }

            // Escape HTML to prevent XSS
            function escapeHtml(text) {
                const div = document.createElement("div");
                div.textContent = text;
                return div.innerHTML;
            }

            // Close modal
            function closeModal() {
                document.getElementById("fileModal").style.display = "none";
            }

            // Handle search input Enter key
            document
                .getElementById("searchInput")
                .addEventListener("keypress", (e) => {
                    if (e.key === "Enter") {
                        performSearch();
                    }
                });

            // Close modal when clicking outside
            window.onclick = function (event) {
                const modal = document.getElementById("fileModal");
                if (event.target === modal) {
                    closeModal();
                }
            };

            // Initialize the browser
            document.addEventListener("DOMContentLoaded", () => {
                loadBookmarks();
                loadDirectory();
            });
        </script>
    </body>
</html>
